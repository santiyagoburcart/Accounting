{% extends "dashboard/base.html" %}
{% load i18n %}

{% block title %}{% trans "Customer Management" %}{% endblock %}
{% block page_title %}{% trans "Customer Management Dashboard" %}{% endblock %}
{% block page_title_desktop %}{% trans "Customer Management Dashboard" %}{% endblock %}

{% block extra_head %}{{ form.media }}{% endblock %}

{% block content %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        <div class="glass-card p-6 flex justify-between items-center">
            <div>
                <h3 class="text-lg text-[var(--text-secondary)]">{% trans "Total Gig Sold" %}</h3>
                <p class="text-3xl font-bold text-blue-400">{{ total_giga }} {% trans "Gig" %}</p>
            </div>
            <div class="p-3 bg-blue-500/10 rounded-xl"><i data-feather="database" class="w-8 h-8 text-blue-400"></i></div>
        </div>
        <div class="glass-card p-6 flex justify-between items-center">
            <div>
                <h3 class="text-lg text-[var(--text-secondary)]">{% trans "Total Paid Revenue" %}</h3>
                <p class="text-3xl font-bold text-success">{{ paid_amount|floatformat:0 }}</p>
            </div>
            <div class="p-3 bg-green-500/10 rounded-xl"><i data-feather="check-circle" class="w-8 h-8 text-success"></i></div>
        </div>
        <div class="glass-card p-6 flex justify-between items-center">
            <div>
                <h3 class="text-lg text-[var(--text-secondary)]">{% trans "Total Unpaid" %}</h3>
                <p class="text-3xl font-bold text-danger">{{ unpaid_amount|floatformat:0 }}</p>
            </div>
             <div class="p-3 bg-red-500/10 rounded-xl"><i data-feather="alert-circle" class="w-8 h-8 text-danger"></i></div>
        </div>
    </div>

    <div class="glass-card p-8">
        <div class="page-header"><h2 class="page-title">{% trans "Customers List" %}</h2></div>

        <div class="filter-container">
            <div>
                <h3 class="filter-group-title">{% trans "Filter by Status" %}</h3>
                <div class="filter-btn-group">
                    <a href="?month={{ request.GET.month|default:'' }}&referrer={{ request.GET.referrer|default:'' }}" class="filter-btn {% if not request.GET.status %}active{% endif %}">{% trans "All" %}</a>
                    <a href="?status=success&month={{ request.GET.month|default:'' }}&referrer={{ request.GET.referrer|default:'' }}" class="filter-btn {% if request.GET.status == 'success' %}active{% endif %}"><span class="status-dot dot-success"></span><span>{% trans "Success" %}</span></a>
                    <a href="?status=pending&month={{ request.GET.month|default:'' }}&referrer={{ request.GET.referrer|default:'' }}" class="filter-btn {% if request.GET.status == 'pending' %}active{% endif %}"><span class="status-dot dot-pending"></span><span>{% trans "Pending" %}</span></a>
                </div>
            </div>
            <form method="get" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" name="status" value="{{ request.GET.status|default:'' }}">
                <div>
                    <label for="month-filter" class="form-label">{% trans "Month" %}</label>
                    <select name="month" id="month-filter" class="form-input" onchange="this.form.submit()">
                        <option value="">{% trans "All Months" %}</option>
                        {% for month_num, month_name in months.items %}<option value="{{ month_num }}" {% if request.GET.month == month_num|stringformat:"s" %}selected{% endif %}>{{ month_name }}</option>{% endfor %}
                    </select>
                </div>
                <div>
                    <label for="referrer-filter" class="form-label">{% trans "Referrer" %}</label>
                    <select name="referrer" id="referrer-filter" class="form-input" onchange="this.form.submit()">
                        <option value="">{% trans "All Referrers" %}</option>
                        {% for referrer in referrer_list %}<option value="{{ referrer }}" {% if request.GET.referrer == referrer %}selected{% endif %}>{{ referrer }}</option>{% endfor %}
                    </select>
                </div>
            </form>
        </div>

        <div class="customer-list">
            {% for customer in customers %}
            <div class="customer-card">
                <div class="customer-info">
                    <span class="customer-name">{{ customer.name }}</span>
                    <span class="customer-price">{{ customer.price|floatformat:0 }}</span>
                    <span class="customer-detail">{% trans "Pay Date" %}: {{ customer.jalali_payment_date }}</span>
                    <span class="customer-detail">{% trans "Exp Date" %}: {{ customer.expire_date|date:"Y-m-d"|default:"-" }}</span>
                </div>
                <div class="customer-actions">
                    {% if customer.status == 'success' %}
                        <span class="status-badge status-success">
                            <i data-feather="check-circle" class="w-4 h-4"></i>
                            <span>{% trans "Success" %}</span>
                        </span>
                    {% else %}
                        <span class="status-badge status-pending">
                            <i data-feather="clock" class="w-4 h-4"></i>
                            <span>{% trans "Pending" %}</span>
                        </span>
                    {% endif %}
                    <a href="{% url 'edit_customer' customer.id %}" title="{% trans 'Edit' %}"><i data-feather="edit-2"></i></a>
                    <form method="post" action="{% url 'delete_customer' customer.id %}" class="delete-form">
                        {% csrf_token %}
                        <button type="button" class="delete-btn" data-customer-name="{{ customer.name }}" title="{% trans 'Delete' %}">
                            <i data-feather="trash-2"></i>
                        </button>
                    </form>
                </div>
            </div>
            {% empty %}
            <div class="text-center p-8 text-[var(--text-secondary)]">{% trans "No customers to display." %}</div>
            {% endfor %}
        </div>
    </div>

    <div class="fab-container"><button id="add-customer-btn" class="fab"><i data-feather="plus"></i></button></div>

    <div id="add-customer-modal" class="modal-overlay">
        <div class="modal-content glass-card p-8 w-full max-w-lg">
            <div class="page-header"><h2 class="page-title">{% trans "Add New Customer" %}</h2><button class="close-modal-btn p-2 rounded-full hover:bg-[var(--border-color)]"><i data-feather="x"></i></button></div>
            <form method="post" class="space-y-4 form-container text-start">
                {% csrf_token %}
                {% for field in form %}{% if field.name == 'status' %}<div class="pt-2"><label class="toggle-wrapper">{{ field }}<div class="toggle-switch"></div><span class="font-medium text-[var(--text-secondary)]">{% trans "Success Status" %}</span></label></div>{% else %}<div><label for="{{ field.id_for_label }}">{{ field.label }}</label>{{ field }}{{ field.errors }}</div>{% endif %}{% endfor %}
                <button type="submit" class="w-full btn btn-gradient mt-4">{% trans "Add Customer" %}</button>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addBtn = document.getElementById('add-customer-btn');
        const modal = document.getElementById('add-customer-modal');
        const closeBtn = modal.querySelector('.close-modal-btn');

        function toggleModal(modal) { if(modal) modal.classList.toggle('active'); }

        if(addBtn) addBtn.addEventListener('click', () => toggleModal(modal));
        if(closeBtn) closeBtn.addEventListener('click', () => toggleModal(modal));
        if(modal) { modal.addEventListener('click', function(event) { if (event.target === modal) { toggleModal(modal); } }); }

        // NEW: SweetAlert2 for delete confirmation
        const deleteButtons = document.querySelectorAll('.delete-btn');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function(event) {
                event.preventDefault();
                const form = this.closest('form');
                const customerName = this.dataset.customerName;

                Swal.fire({
                    title: '{% trans "Are you sure?" %}',
                    text: `{% trans "You are about to delete" %} '${customerName}'. {% trans "This action cannot be undone!" %}`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#bb9af7', // --accent-purple
                    cancelButtonColor: '#f7768e',  // --accent-red
                    confirmButtonText: '{% trans "Yes, delete it!" %}',
                    cancelButtonText: '{% trans "Cancel" %}',
                    background: 'var(--bg-secondary)',
                    color: 'var(--text-primary)'
                }).then((result) => {
                    if (result.isConfirmed) {
                        form.submit();
                    }
                })
            });
        });
    });
</script>
{% endblock %}