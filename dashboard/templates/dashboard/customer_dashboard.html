{% extends "dashboard/base.html" %}
{% load i18n %}

{% block title %}{% trans "Customer Management" %}{% endblock %}
{% block page_title %}{% trans "Customer Management Dashboard" %}{% endblock %}

{% block extra_head %}
    {{ form.media }}
{% endblock %}

{% block content %}
    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
        <div class="glass-card p-6 flex justify-between items-center">
            <div>
                <h3 class="text-lg text-[var(--text-secondary)]">{% trans "Total Gig Sold" %}</h3>
                <p class="text-3xl font-bold text-blue-400">{{ total_giga }} {% trans "Gig" %}</p>
            </div>
            <div class="p-3 bg-blue-500/10 rounded-xl">
                <i data-feather="database" class="w-8 h-8 text-blue-400"></i>
            </div>
        </div>
        <div class="glass-card p-6 flex justify-between items-center">
            <div>
                <h3 class="text-lg text-[var(--text-secondary)]">{% trans "Total Paid Revenue" %}</h3>
                <p class="text-3xl font-bold text-success">{{ paid_amount|floatformat:0 }}</p>
            </div>
            <div class="p-3 bg-green-500/10 rounded-xl">
                <i data-feather="check-circle" class="w-8 h-8 text-success"></i>
            </div>
        </div>
        <div class="glass-card p-6 flex justify-between items-center">
            <div>
                <h3 class="text-lg text-[var(--text-secondary)]">{% trans "Total Unpaid" %}</h3>
                <p class="text-3xl font-bold text-danger">{{ unpaid_amount|floatformat:0 }}</p>
            </div>
             <div class="p-3 bg-red-500/10 rounded-xl">
                <i data-feather="alert-circle" class="w-8 h-8 text-danger"></i>
            </div>
        </div>
    </div>

    <!-- Customer List Card -->
    <div class="glass-card p-8">
         <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
            <h2 class="text-2xl font-bold text-start">{% trans "Customers List" %}</h2>
            <div class="flex items-center w-full md:w-auto gap-4">
                <form method="get" class="flex flex-col md:flex-row items-center w-full md:w-auto gap-2">
                    <select name="month" class="form-input w-full" onchange="this.form.submit()">
                        <option value="">{% trans "All Months" %}</option>
                        {% for month_num, month_name in months.items %}
                            <option value="{{ month_num }}" {% if selected_month == month_num|stringformat:"s" %}selected{% endif %}>{{ month_name }}</option>
                        {% endfor %}
                    </select>
                    <select name="status" class="form-input w-full" onchange="this.form.submit()">
                        <option value="">{% trans "All Statuses" %}</option>
                        <option value="paid" {% if selected_status == 'paid' %}selected{% endif %}>{% trans "Paid" %}</option>
                        <option value="unpaid" {% if selected_status == 'unpaid' %}selected{% endif %}>{% trans "Unpaid" %}</option>
                    </select>
                    <select name="referrer" class="form-input w-full" onchange="this.form.submit()">
                        <option value="">{% trans "All Referrers" %}</option>
                        {% for referrer in referrer_list %}
                            <option value="{{ referrer }}" {% if selected_referrer == referrer %}selected{% endif %}>{{ referrer }}</option>
                        {% endfor %}
                    </select>
                </form>
                <button id="add-customer-btn" class="btn btn-gradient whitespace-nowrap flex items-center gap-2">
                    <i data-feather="user-plus"></i>
                    <span>{% trans "Add New Customer" %}</span>
                </button>
            </div>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-start">
                <thead class="border-b-2 border-[var(--border-color)]">
                    <tr>
                        <th class="p-3 text-start">{% trans "Name" %}</th>
                        <th class="p-3 text-start hidden md:table-cell">{% trans "Expiration" %}</th>
                        <th class="p-3 text-start">{% trans "Payment Date" %}</th>
                        <th class="p-3 text-start">{% trans "Status" %}</th>
                        <th class="p-3 text-start">{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for customer in customers %}
                    <tr class="border-b border-[var(--border-color)] hover:bg-[var(--bg-secondary)]/50">
                        <td class="p-3 font-bold">{{ customer.name }}</td>
                        <td class="p-3 hidden md:table-cell">{{ customer.expire_date|date:"Y-m-d"|default:"-" }}</td>
                        <td class="p-3">{{ customer.jalali_payment_date }}</td>
                        <td class="p-3">
                            {% if customer.is_paid %}
                                <span class="status-badge status-paid">
                                    <i data-feather="check-circle" class="w-4 h-4"></i>
                                    {% trans "Paid" %}
                                </span>
                            {% else %}
                                <span class="status-badge status-unpaid">
                                    <i data-feather="x-circle" class="w-4 h-4"></i>
                                    {% trans "Unpaid" %}
                                </span>
                            {% endif %}
                        </td>
                        <td class="p-3">
                            <div class="flex items-center gap-2">
                                <a href="{% url 'edit_customer' customer.id %}" class="text-blue-400 hover:text-blue-600"><i data-feather="edit-2"></i></a>
                                <form method="post" action="{% url 'delete_customer' customer.id %}" onsubmit="return confirm('{% trans "Are you sure?" %}');">
                                    {% csrf_token %}
                                    <button type="submit" class="text-red-400 hover:text-red-600"><i data-feather="trash-2"></i></button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="5" class="text-center p-8 text-[var(--text-secondary)]">{% trans "No customers to display." %}</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Add Customer Modal -->
    <div id="add-customer-modal" class="modal-overlay">
        <div class="modal-content glass-card p-8 w-full max-w-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">{% trans "Add New Customer" %}</h2>
                <button class="close-modal-btn p-2 rounded-full hover:bg-[var(--border-color)]">
                    <i data-feather="x"></i>
                </button>
            </div>
            <form method="post" class="space-y-4 form-container text-start">
                {% csrf_token %}

                {% for field in form %}
                    {% if field.name == 'is_paid' %}
                        <div class="pt-2">
                            <label class="toggle-wrapper">
                                {{ field }}
                                <div class="toggle-switch"></div>
                                <span class="font-medium text-[var(--text-secondary)]">{{ field.label }}</span>
                            </label>
                        </div>
                    {% else %}
                        <div>
                            <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                            {{ field }}
                            {{ field.errors }}
                        </div>
                    {% endif %}
                {% endfor %}

                <button type="submit" class="w-full btn btn-gradient mt-4">{% trans "Add Customer" %}</button>
            </form>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addBtn = document.getElementById('add-customer-btn');
        const modal = document.getElementById('add-customer-modal');
        const closeBtn = modal.querySelector('.close-modal-btn');

        function toggleModal() {
            modal.classList.toggle('active');
        }

        if(addBtn) addBtn.addEventListener('click', toggleModal);
        if(closeBtn) closeBtn.addEventListener('click', toggleModal);
        if(modal) {
            modal.addEventListener('click', function(event) {
                if (event.target === modal) {
                    toggleModal();
                }
            });
        }
    });
</script>
{% endblock %}