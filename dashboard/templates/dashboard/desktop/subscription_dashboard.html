{% extends "dashboard/desktop/base.html" %}
{% load i18n %}
{% load humanize %}

{% block title %}{% trans "Subscriptions Management" %}{% endblock %}

{# --- تغییر نام صفحه به Subscriptions --- #}
{% block page_title %}{% trans "Subscriptions" %}{% endblock %}
{% block page_title_desktop %}{% trans "Subscriptions Dashboard" %}{% endblock %}

{% block content %}

{# START: PRO CARDS SECTION (Glassmorphism & Neon) #}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">

    {# Card 1: Total Sold (Purple Theme) #}
    <div class="glass-card p-6 relative overflow-hidden group hover:border-purple-500/50 transition-all duration-300">
        <div class="absolute -right-6 -top-6 w-24 h-24 bg-purple-500/20 rounded-full blur-2xl group-hover:bg-purple-500/30 transition-all"></div>

        <div class="flex items-center justify-between mb-4 relative z-10">
            <div class="p-3 bg-purple-500/10 rounded-xl text-purple-400 group-hover:scale-110 transition-transform">
                <i data-feather="database" class="w-6 h-6"></i>
            </div>
            <span class="text-xs font-bold text-emerald-400 bg-emerald-400/10 px-2 py-1 rounded-full flex items-center gap-1">
                <i data-feather="trending-up" class="w-3 h-3"></i> +12%
            </span>
        </div>

        <h3 class="text-[var(--text-muted)] text-sm font-medium mb-1">{% trans "Total GB's Sold" %}</h3>
        <p class="text-3xl font-black text-[var(--text-main)]">
            {{ total_giga_sold }} <span class="text-sm font-normal text-gray-500">{% trans "GB" %}</span>
        </p>
    </div>

    {# Card 2: Total Revenue (Blue Gradient Text) #}
    <div class="glass-card p-6 relative overflow-hidden group hover:border-blue-500/50 transition-all duration-300">
        <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-500/20 rounded-full blur-2xl group-hover:bg-blue-500/30 transition-all"></div>

        <div class="flex items-center justify-between mb-4 relative z-10">
            <div class="p-3 bg-blue-500/10 rounded-xl text-blue-400 group-hover:scale-110 transition-transform">
                <i data-feather="dollar-sign" class="w-6 h-6"></i>
            </div>
        </div>

        <h3 class="text-[var(--text-muted)] text-sm font-medium mb-1">{% trans "Total Revenue" %}</h3>
        <p class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300">
            {{ total_amount|floatformat:0|intcomma }} <span class="text-sm font-normal text-gray-500">T</span>
        </p>
    </div>

    {# Card 3: Paid (Emerald Theme with Chart) #}
    <div class="glass-card p-6 relative overflow-hidden group hover:border-emerald-500/50 transition-all duration-300">
        <div class="absolute -right-6 -top-6 w-24 h-24 bg-emerald-500/20 rounded-full blur-2xl group-hover:bg-emerald-500/30 transition-all"></div>

        <div class="flex justify-between items-start relative z-10">
            <div>
                <div class="p-3 bg-emerald-500/10 rounded-xl text-emerald-400 w-fit mb-4 group-hover:scale-110 transition-transform">
                    <i data-feather="check-circle" class="w-6 h-6"></i>
                </div>
                <h3 class="text-[var(--text-muted)] text-sm font-medium mb-1">{% trans "Paid Amount" %}</h3>
                <p class="text-2xl font-bold text-[var(--text-main)]">{{ paid_amount|floatformat:0|intcomma }}</p>
            </div>
            <div id="paid-chart" class="mt-2 scale-110 origin-top-right"></div>
        </div>
    </div>

    {# Card 4: Unpaid (Rose Theme with Chart) #}
    <div class="glass-card p-6 relative overflow-hidden group hover:border-rose-500/50 transition-all duration-300">
        <div class="absolute -right-6 -top-6 w-24 h-24 bg-rose-500/20 rounded-full blur-2xl group-hover:bg-rose-500/30 transition-all"></div>

        <div class="flex justify-between items-start relative z-10">
            <div>
                <div class="p-3 bg-rose-500/10 rounded-xl text-rose-400 w-fit mb-4 group-hover:scale-110 transition-transform">
                    <i data-feather="alert-circle" class="w-6 h-6"></i>
                </div>
                <h3 class="text-[var(--text-muted)] text-sm font-medium mb-1">{% trans "Unpaid Amount" %}</h3>
                <p class="text-2xl font-bold text-rose-400">{{ unpaid_amount|floatformat:0|intcomma }}</p>
            </div>
            <div id="unpaid-chart" class="mt-2 scale-110 origin-top-right"></div>
        </div>
    </div>
</div>
{# END: PRO CARDS SECTION #}


{# START: Main Table Card #}
<div class="glass-card p-4 sm:p-6 mt-6">

    <form method="get">
        {# Header: Search and Add Button #}
        <div class="flex flex-col md:flex-row justify-between items-center gap-4 pb-4 border-b border-[var(--border-color)]">

            {# Search #}
            <div class="relative w-full md:w-1/3 lg:w-1/4">
                <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                    <i data-feather="search" class="w-5 h-5 text-gray-400"></i>
                </span>
                <input type="search" name="q" value="{{ search_query }}" placeholder="{% trans "Search..." %}"
                       class="w-full pl-10 pr-4 py-2 form-input">
            </div>

            {# Add Modal Button #}
            <div class="w-full md:w-auto">
                <button type="button" id="openAddModalBtn"
                        class="w-full md:w-auto flex items-center justify-center px-4 py-2 bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-semibold rounded-xl shadow-lg shadow-blue-500/30 hover:shadow-blue-500/50 transition-all hover:-translate-y-1">
                    <i data-feather="plus" class="inline-block w-5 h-5 mr-1"></i>
                    {% trans "Add Subscription" %}
                </button>
            </div>
        </div>

        {# Filters: Tabs and Date #}
        <div class="flex flex-col md:flex-row justify-between items-center gap-4 py-4">

            {# Status Tabs #}
            <div class="flex items-center gap-2 p-1 bg-[var(--bg-body)] rounded-lg border border-[var(--border-color)]">
                <a href="?status=all&year={{ selected_year }}&month={{ selected_month }}&q={{ search_query }}"
                   class="px-4 py-1.5 rounded-md text-sm font-medium transition-all {% if status_filter == 'all' %}bg-[var(--bg-card)] text-[var(--primary)] shadow-sm{% else %}text-[var(--text-muted)] hover:text-[var(--text-main)]{% endif %}">
                    {% trans "All" %}
                </a>
                <a href="?status=paid&year={{ selected_year }}&month={{ selected_month }}&q={{ search_query }}"
                   class="px-4 py-1.5 rounded-md text-sm font-medium transition-all {% if status_filter == 'paid' %}bg-[var(--bg-card)] text-emerald-400 shadow-sm{% else %}text-[var(--text-muted)] hover:text-[var(--text-main)]{% endif %}">
                    {% trans "Paid" %}
                </a>
                <a href="?status=unpaid&year={{ selected_year }}&month={{ selected_month }}&q={{ search_query }}"
                   class="px-4 py-1.5 rounded-md text-sm font-medium transition-all {% if status_filter == 'unpaid' %}bg-[var(--bg-card)] text-rose-400 shadow-sm{% else %}text-[var(--text-muted)] hover:text-[var(--text-main)]{% endif %}">
                    {% trans "Unpaid" %}
                </a>
            </div>

            {# Date Filters #}
            <div class="flex items-center gap-2">
                <select name="month" class="w-32 form-select" onchange="this.form.submit()">
                    {% for month_num, month_name in months.items %}
                        <option value="{{ month_num }}" {% if month_num == selected_month %}selected{% endif %}>{{ month_name }}</option>
                    {% endfor %}
                </select>
                <select name="year" class="w-24 form-select" onchange="this.form.submit()">
                    {% for year in years %}
                        <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </form>

    {# Table #}
    <div class="overflow-x-auto">
        <table class="custom-table w-full text-sm text-left rtl:text-right">
            <thead>
                <tr>
                    <th>{% trans "Customer" %}</th>
                    <th>{% trans "Referrer" %}</th>
                    <th>{% trans "Price" %}</th>
                    <th>{% trans "GB" %}</th>
                    <th>{% trans "Payment Date" %}</th>
                    <th>{% trans "Expire Date" %}</th>
                    <th>{% trans "Status" %}</th>
                    <th class="text-center">{% trans "Actions" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for sub in subscriptions %}
                    <tr class="transition-colors duration-200">
                        <td class="font-bold text-[var(--text-main)]">{{ sub.customer.name }}</td>
                        <td class="text-[var(--text-muted)]">{{ sub.referrer.name|default:"-" }}</td>
                        <td class="font-mono">{{ sub.price|floatformat:0|intcomma }}</td>
                        <td class="font-mono text-[var(--primary)]">{{ sub.giga }}</td>
                        <td>{{ sub.jalali_payment_date }}</td>
                        <td>{{ sub.expire_date|date:"Y/m/d"|default:"-" }}</td>
                        <td>
                            {% if sub.status == 'success' %}
                                <span class="status-badge status-paid">
                                    {% trans "Paid" %}
                                </span>
                            {% else %}
                                <span class="status-badge status-unpaid">
                                    {% trans "Unpaid" %}
                                </span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <div class="flex items-center justify-center gap-3">
                                <a href="{% url 'dashboard:subscription_edit' sub.pk %}" class="p-2 rounded-lg hover:bg-blue-500/10 text-blue-400 transition-colors">
                                     <i data-feather="edit-2" class="w-4 h-4"></i>
                                </a>
                                <button type="button"
                                        data-url="{% url 'dashboard:subscription_delete' sub.pk %}"
                                        data-name="{{ sub.customer.name }}"
                                        onclick="openDeleteModal(this)"
                                        class="p-2 rounded-lg hover:bg-red-500/10 text-red-400 transition-colors">
                                     <i data-feather="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="8" class="p-8 text-center text-[var(--text-muted)]">
                            <div class="flex flex-col items-center gap-2">
                                <i data-feather="inbox" class="w-10 h-10 opacity-50"></i>
                                <p>{% trans "No subscriptions found." %}</p>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{# END: Main Table Card #}


{# START: Add Modal #}
<div id="addSubscriptionModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-6 sm:p-8 w-full max-w-3xl max-h-[90vh] overflow-y-auto border border-[var(--border-color)] shadow-2xl">

        <div class="flex justify-between items-center mb-6 border-b border-[var(--border-color)] pb-4">
            <h2 class="text-2xl font-bold text-[var(--text-main)]">{% trans "Add New Subscription" %}</h2>
            <button type="button" id="closeAddModalBtn" class="text-[var(--text-muted)] hover:text-white transition-colors">
                <i data-feather="x" class="w-6 h-6"></i>
            </button>
        </div>

        <form method="post" action="{% url 'dashboard:subscription_dashboard' %}?year={{ selected_year }}&month={{ selected_month }}" class="form-container">
            {% csrf_token %}

            {% if form.errors %}
                <div class="p-4 mb-4 text-sm text-red-400 bg-red-500/10 border border-red-500/20 rounded-xl" role="alert">
                    <p class="font-bold mb-2">{% trans "Please correct the errors below:" %}</p>
                    {{ form.non_field_errors }}
                    <ul class="list-disc list-inside">
                    {% for field in form %}
                        {% for error in field.errors %}
                            <li>{{ field.label }}: {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    </ul>
                </div>
            {% endif %}

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-[var(--text-secondary)] mb-2">{% trans "Customer" %}</label>
                    {{ form.customer }}
                </div>

                <div>
                    <label class="block text-sm font-medium text-[var(--text-secondary)] mb-2">{% trans "Year (Shamsi)" %}</label>
                    {{ form.year }}
                </div>

                <div>
                    <label class="block text-sm font-medium text-[var(--text-secondary)] mb-2">{% trans "Month (Shamsi)" %}</label>
                    {{ form.month }}
                </div>

                <div>
                    <label class="block text-sm font-medium text-[var(--text-secondary)] mb-2">{% trans "Price" %}</label>
                    <input type="{{ form.price.field.widget.input_type }}" name="{{ form.price.name }}" id="id_price" value="{{ form.price.value|default_if_none:'' }}"
                           class="form-input">
                </div>

                <div>
                    <label class="block text-sm font-medium text-[var(--text-secondary)] mb-2">{% trans "Giga" %}</label>
                    <input type="{{ form.giga.field.widget.input_type }}" name="{{ form.giga.name }}" id="id_giga" value="{{ form.giga.value|default_if_none:'' }}"
                           class="form-input">
                </div>

                <div class="flex items-center pt-6">
                    <label class="switch form-switch">
                        <input type="hidden" name="status" value="pending">
                        <input type="checkbox" id="id_status" name="status" value="success" {% if form.status.value == 'success' or not form.is_bound %}checked{% endif %}>
                        <span class="switch-slider"></span>
                    </label>
                    <label for="id_status" class="mx-3 block text-sm font-medium text-[var(--text-main)]">{% trans "Paid Status" %}</label>
                </div>

                <div>
                    <label class="block text-sm font-medium text-[var(--text-secondary)] mb-2">{% trans "Payment Date (Shamsi)" %}</label>
                    <input type="text" name="{{ form.payment_date.name }}" id="id_payment_date" value="{{ form.payment_date.value|default_if_none:'' }}" autocomplete="off"
                           class="form-input jalali-datepicker">
                </div>

                <div>
                    <label class="block text-sm font-medium text-[var(--text-secondary)] mb-2">{% trans "Expiration Date (Gregorian)" %}</label>
                    <input type="date" name="{{ form.expire_date.name }}" id="id_expire_date" value="{{ form.expire_date.value|default_if_none:''|date:'Y-m-d' }}"
                           class="form-input">
                </div>

                <div>
                    <label class="block text-sm font-medium text-[var(--text-secondary)] mb-2">{% trans "Service Referrer" %}</label>
                    {{ form.referrer }}
                </div>

                <div>
                    <label class="block text-sm font-medium text-[var(--text-secondary)] mb-2">{% trans "Destination Bank" %}</label>
                    {{ form.destination_bank }}
                </div>

            </div>

            <button type="submit" name="add_subscription"
                    class="w-full mt-8 px-4 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white font-bold rounded-xl shadow-lg hover:shadow-purple-500/40 transition-all hover:-translate-y-1">
                {% trans "Add Subscription" %}
            </button>
        </form>
    </div>
</div>
{# END: Add Modal #}


{# START: Delete Modal #}
<div id="deleteModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-8 w-full max-w-md text-center border border-[var(--border-color)]">
        <div class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">
            <i data-feather="alert-triangle" class="w-8 h-8"></i>
        </div>
        <h2 class="text-xl font-bold mb-2 text-[var(--text-main)]">{% trans "Confirm Deletion" %}</h2>
        <p class="mb-6 text-[var(--text-muted)]">{% trans "Are you sure you want to delete the subscription for" %} <strong id="customerName" class="text-[var(--text-main)]"></strong>?</p>

        <form id="deleteForm" method="post" action=""> {% csrf_token %}
            <div class="flex justify-center gap-4">
                <button type="button" onclick="closeDeleteModal()"
                        class="px-6 py-2 rounded-xl border border-[var(--border-color)] text-[var(--text-muted)] hover:bg-[var(--bg-body)] transition-colors">
                    {% trans "Cancel" %}
                </button>
                <button type="submit"
                        class="px-6 py-2 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-colors shadow-lg shadow-red-500/20">
                    {% trans "Delete" %}
                </button>
            </div>
        </form>
    </div>
</div>
{# END: Delete Modal #}

{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
$(document).ready(function() {
    // Select2 Settings
    const select2Options = {
        theme: "classic",
        width: '100%',
        dir: document.documentElement.dir
    };
    const select2ModalOptions = {
        ...select2Options,
        dropdownParent: $('#addSubscriptionModal')
    };

    // Filter Select2
    $('select[name="month"]').select2(select2Options);
    $('select[name="year"]').select2(select2Options);

    // Modal Select2
    $('#id_customer').select2({ ...select2ModalOptions, placeholder: "{% trans 'Select a customer...' %}" });
    $('#id_referrer').select2({ ...select2ModalOptions, placeholder: "{% trans 'Select a referrer...' %}", allowClear: true });
    $('#id_destination_bank').select2({ ...select2ModalOptions, placeholder: "{% trans 'Select a bank account...' %}", allowClear: true });
    $('#id_year').select2(select2ModalOptions);
    $('#id_month').select2(select2ModalOptions);

    // --- SMART FORM LOGIC: Auto-fill Referrer ---
    $('#id_customer').on('change', function() {
        var customerId = $(this).val();
        if (customerId) {
            // نمایش لودینگ (اختیاری ولی حرفه‌ای)
            // $('#id_referrer').prop('disabled', true);

            $.ajax({
                url: "{% url 'dashboard:get_customer_details' %}",
                data: { 'customer_id': customerId },
                dataType: 'json',
                success: function(data) {
                    if (data.referrer_id) {
                        // اگر مشتری معرف داشت، فیلد معرف رو پر کن
                        $('#id_referrer').val(data.referrer_id).trigger('change');

                        // یه افکت کوچیک سبز رنگ به فیلد بده که کاربر بفهمه خودکار پر شده
                        $('#id_referrer').next('.select2-container').find('.select2-selection').css('border-color', '#34d399');
                        setTimeout(() => {
                             $('#id_referrer').next('.select2-container').find('.select2-selection').css('border-color', '');
                        }, 2000);

                        Toastify({
                            text: "Referrer auto-filled! ✨",
                            duration: 3000,
                            gravity: "bottom",
                            position: "right",
                            style: { background: "linear-gradient(to right, #00b09b, #96c93d)" }
                        }).showToast();
                    } else {
                        // اگر معرف نداشت، فیلد رو خالی کن (یا دست نزن)
                        $('#id_referrer').val('').trigger('change');
                    }
                },
                error: function(xhr, status, error) {
                    console.error("Error fetching customer details:", error);
                },
                complete: function() {
                    // $('#id_referrer').prop('disabled', false);
                }
            });
        }
    });

    // --- Charts Logic ---
    const totalAmount = {{ total_amount|default:0 }};
    const paidAmount = {{ paid_amount|default:0 }};
    // درصدگیری ساده
    const paidPercentage = totalAmount > 0 ? Math.round((paidAmount / totalAmount) * 100) : 0;
    const unpaidPercentage = 100 - paidPercentage;

    const chartOptions = {
        chart: { type: 'radialBar', height: 80, width: 80, sparkline: { enabled: true } },
        plotOptions: {
            radialBar: {
                hollow: { size: '45%' },
                track: { background: 'rgba(255,255,255,0.1)' },
                dataLabels: {
                    name: { show: false },
                    value: { show: false } // عدد وسط رو نشون نمیدیم چون جا کمه، فقط دایره
                }
            }
        },
        stroke: { lineCap: 'round' },
        tooltip: { enabled: false }
    };

    if (document.querySelector("#paid-chart")) {
        new ApexCharts(document.querySelector("#paid-chart"), {...chartOptions, series: [paidPercentage], colors: ['#34d399']}).render();
    }
    if (document.querySelector("#unpaid-chart")) {
        new ApexCharts(document.querySelector("#unpaid-chart"), {...chartOptions, series: [unpaidPercentage], colors: ['#fb7185']}).render();
    }

    feather.replace();
});

// --- Modal Logic ---
const addModal = document.getElementById('addSubscriptionModal');
const openAddModalBtn = document.getElementById('openAddModalBtn');
const closeAddModalBtn = document.getElementById('closeAddModalBtn');

if (openAddModalBtn) {
    openAddModalBtn.onclick = function() {
        addModal.classList.remove('hidden');
        const currentYear = $('#filter_year').val();
        const currentMonth = $('#filter_month').val();
        $('#id_year').val('{{ selected_year }}').trigger('change');
        $('#id_month').val('{{ selected_month }}').trigger('change');
        window.initPersianDatepicker("#addSubscriptionModal .jalali-datepicker");
    }
}
if (closeAddModalBtn) {
    closeAddModalBtn.onclick = function() { addModal.classList.add('hidden'); }
}

// --- Delete Modal Logic ---
const deleteModal = document.getElementById('deleteModal');
const deleteForm = document.getElementById('deleteForm');
const customerNameSpan = document.getElementById('customerName');

function openDeleteModal(button) {
    const url = button.dataset.url;
    const name = button.dataset.name;
    deleteForm.action = url;
    customerNameSpan.textContent = name;
    deleteModal.classList.remove('hidden');
}
function closeDeleteModal() {
    deleteModal.classList.add('hidden');
}

window.addEventListener('click', function(event) {
    if (event.target == addModal) { addModal.classList.add('hidden'); }
    if (event.target == deleteModal) { closeDeleteModal(); }
});

{% if form.errors %}
    addModal.classList.remove('hidden');
    $(document).ready(function() {
        window.initPersianDatepicker("#addSubscriptionModal .jalali-datepicker");
    });
{% endif %}
</script>
{% endblock %}