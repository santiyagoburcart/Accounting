{% extends "dashboard/base.html" %}
{% load i18n %}

{% block title %}{% trans "Financial Report" %}{% endblock %}
{% block page_title %}{% trans "Monthly Financial Report" %}{% endblock %}

{% block extra_head %}
    {{ expense_form.media }}
    {{ other_income_form.media }}
    <style>
        .text-success { color: #9ece6a; }
        .text-danger { color: #f7768e; }
        .form-container p { margin-bottom: 1rem; }
        .form-container label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 500; }
    </style>
{% endblock %}

{% block content %}
    <!-- Month Filter -->
    <div class="glass-card p-4 mb-8">
        <form method="get" class="flex flex-col md:flex-row items-center gap-4">
            <label for="month-select" class="font-bold">{% trans "Show report for month:" %}</label>
            <select name="month" id="month-select" class="form-input w-full md:w-auto" onchange="this.form.submit()">
                <option value="">{% trans "All Months" %}</option>
                {% for month_num, month_name in months.items %}
                    <option value="{{ month_num }}" {% if selected_month == month_num|stringformat:"s" %}selected{% endif %}>{{ month_name }}</option>
                {% endfor %}
            </select>
        </form>
    </div>

    <!-- Financial Summary -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="glass-card p-6 text-center">
            <h3 class="text-lg text-gray-400">{% trans "Total Income" %}</h3>
            <p class="text-3xl font-bold text-success">{{ total_income|floatformat:0 }}</p>
        </div>
        <div class="glass-card p-6 text-center">
            <h3 class="text-lg text-gray-400">{% trans "Total Expenses" %}</h3>
            <p class="text-3xl font-bold text-danger">{{ total_expenses|floatformat:0 }}</p>
        </div>
        <div class="glass-card p-6 text-center">
            <h3 class="text-lg text-gray-400">{% trans "Net Profit" %}</h3>
            <p class="text-3xl font-bold {% if net_profit >= 0 %}text-success{% else %}text-danger{% endif %}">{{ net_profit|floatformat:0 }}</p>
        </div>
    </div>

    <!-- Forms and Lists -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Other Incomes Section -->
        <div class="glass-card p-8 space-y-6">
            <h2 class="text-2xl font-bold text-start">{% trans "Add Income (Server & Support)" %}</h2>
            <form method="post" class="space-y-4 form-container">
                {% csrf_token %}
                {{ other_income_form.as_p }}
                <button type="submit" name="add_other_income" class="w-full btn-gradient text-white font-bold py-3 px-4 rounded-lg">{% trans "Add Income" %}</button>
            </form>
            <hr class="border-gray-700">
            <h3 class="text-xl font-bold pt-4 text-start">{% trans "Incomes List" %}</h3>
            <ul class="space-y-2">
                {% for income in other_incomes %}
                    <li class="flex justify-between items-center bg-gray-800/50 p-3 rounded">
                        <div>
                            <span class="font-bold">{{ income.name }}</span>
                            <span class="text-sm text-gray-400 block">{{ income.jalali_deposit_date }}</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="font-bold text-success">{{ income.price|floatformat:0 }}</span>
                            <form method="post" action="{% url 'delete_other_income' income.id %}" onsubmit="return confirm('{% trans "Are you sure?" %}');">
                                {% csrf_token %}
                                <button type="submit"><i data-feather="trash-2" class="text-red-500 hover:text-red-400"></i></button>
                            </form>
                        </div>
                    </li>
                {% empty %}
                    <li class="text-gray-500 text-center py-4">{% trans "No income has been recorded." %}</li>
                {% endfor %}
            </ul>
        </div>

        <!-- Expenses Section -->
        <div class="glass-card p-8 space-y-6">
            <h2 class="text-2xl font-bold text-start">{% trans "Add Daily Expense" %}</h2>
            <form method="post" class="space-y-4 form-container">
                {% csrf_token %}
                {{ expense_form.as_p }}
                <button type="submit" name="add_expense" class="w-full btn-gradient text-white font-bold py-3 px-4 rounded-lg">{% trans "Add Expense" %}</button>
            </form>
            <hr class="border-gray-700">
            <h3 class="text-xl font-bold pt-4 text-start">{% trans "Expenses List" %}</h3>
            <ul class="space-y-2">
                {% for expense in expenses %}
                    <li class="flex justify-between items-center bg-gray-800/50 p-3 rounded">
                        <div>
                            <span class="font-bold">{{ expense.issue }}</span>
                            <span class="text-sm text-gray-400 block">{{ expense.jalali_spending_date }}</span>
                        </div>
                        <div class="flex items-center gap-4">
                            <span class="font-bold text-danger">{{ expense.price|floatformat:0 }}</span>
                            <form method="post" action="{% url 'delete_expense' expense.id %}" onsubmit="return confirm('{% trans "Are you sure?" %}');">
                                {% csrf_token %}
                                <button type="submit"><i data-feather="trash-2" class="text-red-500 hover:text-red-400"></i></button>
                            </form>
                        </div>
                    </li>
                {% empty %}
                    <li class="text-gray-500 text-center py-4">{% trans "No expense has been recorded." %}</li>
                {% endfor %}
            </ul>
        </div>
    </div>
{% endblock %}

