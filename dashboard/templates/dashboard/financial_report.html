{% extends "dashboard/base.html" %}
{% load i18n %}
{% load mathfilters %}
{% load humanize %}
{% load custom_filters %}

{% block title %}{% trans "Financial Report" %}{% endblock %}

{# حذف هدر پیش‌فرض بیس #}
{% block header_content %}{% endblock %}

{% block content %}
    <div class="relative w-full bg-gradient-to-r from-slate-900/90 to-emerald-900/90 backdrop-blur-xl rounded-3xl p-8 mb-10 border border-white/10 shadow-2xl overflow-hidden group">
        <div class="absolute top-0 right-0 -mr-20 -mt-20 w-80 h-80 bg-emerald-500/20 rounded-full blur-[100px] group-hover:bg-emerald-500/30 transition-all duration-700"></div>
        <div class="absolute bottom-0 left-0 -ml-20 -mb-20 w-80 h-80 bg-blue-500/20 rounded-full blur-[100px] group-hover:bg-blue-500/30 transition-all duration-700"></div>
        <div class="absolute inset-0 opacity-[0.03] bg-[url('https://grainy-gradients.vercel.app/noise.svg')]"></div>

        <div class="relative flex flex-col md:flex-row justify-between items-center gap-6 z-10">
            <div class="text-center md:text-left w-full">
                <div class="flex items-center justify-center md:justify-start gap-3 mb-2">
                    <div class="px-3 py-1 rounded-full bg-white/5 border border-white/10 text-[10px] font-bold tracking-widest text-emerald-300 uppercase shadow-sm">
                        {% trans "Analytics & Reports" %}
                    </div>
                </div>

                <h1 class="text-4xl md:text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white via-emerald-100 to-emerald-300 tracking-tight mb-3 drop-shadow-sm">
                    {% trans "Financial Report" %}
                </h1>

                <p class="text-slate-300 text-lg font-medium opacity-90">
                    {% trans "Deep dive into your income, expenses, and trends." %}
                </p>
            </div>

            <div class="flex-shrink-0">
                <div class="flex items-center gap-4 bg-white/5 backdrop-blur-md border border-white/10 p-4 rounded-2xl shadow-xl hover:scale-105 transition-transform duration-300">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-emerald-500 to-teal-600 flex items-center justify-center text-white shadow-lg shadow-emerald-500/30">
                        <i data-feather="calendar" class="w-6 h-6"></i>
                    </div>
                    <div class="flex flex-col text-left">
                        <span class="text-xs text-emerald-200 uppercase tracking-wider font-semibold mb-0.5">{% trans "Selected Period" %}</span>
                        <span class="text-white font-bold text-xl tracking-wide font-mono">
                            {{ selected_year }}
                            {% if selected_month %} / {{ selected_month }}{% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass-card p-6 flex justify-between items-center relative overflow-hidden group hover:-translate-y-2 hover:shadow-2xl hover:shadow-emerald-500/20 hover:border-emerald-500/50 transition-all duration-300 cursor-default">
                    <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i data-feather="trending-up" class="w-24 h-24"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-[var(--text-muted)] uppercase tracking-wider mb-1">{% trans "Total Income" %}</h3>
                        <p class="text-2xl font-black text-emerald-400 group-hover:scale-110 transition-transform origin-left">{{ total_income|intcomma }}</p>
                    </div>
                    <div class="radial-progress text-emerald-500 text-xs font-bold group-hover:text-emerald-400 transition-colors" style="--value:100; --size:3.5rem; --thickness: 4px;">100%</div>
                </div>

                <div class="glass-card p-6 flex justify-between items-center relative overflow-hidden group hover:-translate-y-2 hover:shadow-2xl hover:shadow-rose-500/20 hover:border-rose-500/50 transition-all duration-300 cursor-default">
                     <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i data-feather="trending-down" class="w-24 h-24"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-[var(--text-muted)] uppercase tracking-wider mb-1">{% trans "Total Expenses" %}</h3>
                        <p class="text-2xl font-black text-rose-400 group-hover:scale-110 transition-transform origin-left">{{ total_expenses|intcomma }}</p>
                    </div>
                    {% if total_income > 0 %}
                    <div class="radial-progress text-rose-500 text-xs font-bold group-hover:text-rose-400 transition-colors" style="--value:{% widthratio total_expenses total_income 100 %}; --size:3.5rem; --thickness: 4px;">
                        {% widthratio total_expenses total_income 100 %}%
                    </div>
                    {% else %}
                    <div class="radial-progress text-rose-500 text-xs font-bold" style="--value:0; --size:3.5rem; --thickness: 4px;">0%</div>
                    {% endif %}
                </div>

                <div class="glass-card p-6 flex justify-between items-center relative overflow-hidden group hover:-translate-y-2 hover:shadow-2xl hover:shadow-indigo-500/20 hover:border-indigo-500/50 transition-all duration-300 cursor-default">
                     <div class="absolute right-0 top-0 p-4 opacity-5 group-hover:opacity-10 transition-opacity">
                        <i data-feather="pie-chart" class="w-24 h-24"></i>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold text-[var(--text-muted)] uppercase tracking-wider mb-1">{% trans "Net Profit" %}</h3>
                        <p class="text-2xl font-black {% if net_profit >= 0 %}text-indigo-400{% else %}text-rose-400{% endif %} group-hover:scale-110 transition-transform origin-left">
                            {{ net_profit|intcomma }}
                        </p>
                    </div>
                    {% if total_income > 0 and net_profit > 0 %}
                    <div class="radial-progress text-indigo-500 text-xs font-bold group-hover:text-indigo-400 transition-colors" style="--value:{% widthratio net_profit total_income 100 %}; --size:3.5rem; --thickness: 4px;">
                        {% widthratio net_profit total_income 100 %}%
                    </div>
                    {% else %}
                    <div class="radial-progress text-gray-500 text-xs font-bold" style="--value:0; --size:3.5rem; --thickness: 4px;">0%</div>
                    {% endif %}
                </div>
            </div>

            <div class="glass-card p-6 hover:shadow-lg transition-shadow duration-300">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 border-b border-[var(--border-color)] pb-4">
                    <h3 class="text-lg font-bold flex items-center gap-2">
                        <i data-feather="activity" class="text-indigo-400 w-5 h-5"></i>
                        {% trans "Financial Activity" %}
                    </h3>
                    <div class="flex bg-[var(--bg-body)] rounded-lg p-1 border border-[var(--border-color)]">
                        <a href="?timeframe=daily&year={{ selected_year }}&month={{ selected_month|default_if_none:'' }}"
                           class="px-4 py-1.5 rounded-md text-sm font-medium transition-all {% if current_timeframe == 'daily' and selected_month %}bg-[var(--primary-color)] text-white shadow-lg{% elif not selected_month %}opacity-50 cursor-not-allowed text-[var(--text-muted)]{% else %}text-[var(--text-secondary)] hover:text-white{% endif %}">
                           {% trans "Daily" %}
                        </a>
                        <a href="?timeframe=monthly&year={{ selected_year }}"
                           class="px-4 py-1.5 rounded-md text-sm font-medium transition-all {% if current_timeframe == 'monthly' %}bg-[var(--primary-color)] text-white shadow-lg{% else %}text-[var(--text-secondary)] hover:text-white{% endif %}">
                           {% trans "Monthly" %}
                        </a>
                    </div>
                </div>
                <div class="h-72 w-full">
                    <canvas id="activityChart"></canvas>
                </div>
            </div>

            <div class="glass-card p-0 overflow-hidden hover:shadow-xl hover:border-rose-500/30 transition-all duration-300">
                <div class="p-6 border-b border-[var(--border-color)] bg-gradient-to-r from-rose-900/20 to-transparent flex justify-between items-center">
                    <div class="flex items-center gap-3">
                        <div class="p-2.5 bg-rose-500/20 rounded-xl text-rose-400 shadow-inner">
                            <i data-feather="credit-card" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-white">{% trans "Top Spending Categories" %}</h3>
                            <p class="text-xs text-[var(--text-muted)]">
                                {% if selected_month %}{% trans "In" %} {{ selected_month }} {{ selected_year }}{% else %}{% trans "In" %} {{ selected_year }}{% endif %}
                            </p>
                        </div>
                    </div>
                </div>

                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    {% for expense in top_expenses %}
                        <div class="group relative bg-[var(--bg-body)] p-4 rounded-xl border border-[var(--border-color)] hover:border-rose-500/40 transition-all">
                            <div class="flex justify-between items-center mb-3">
                                <div class="flex items-center gap-3">
                                    <span class="w-8 h-8 rounded-lg bg-[var(--bg-card)] border border-[var(--border-color)] flex items-center justify-center text-sm font-bold text-[var(--text-secondary)] group-hover:bg-rose-500 group-hover:text-white group-hover:border-rose-500 transition-all shadow-sm">
                                        {{ forloop.counter }}
                                    </span>
                                    <span class="font-bold text-[var(--text-main)] group-hover:text-rose-400 transition-colors">{{ expense.issue }}</span>
                                </div>
                                <span class="font-mono font-bold text-rose-400 bg-rose-500/10 px-2 py-1 rounded text-sm">{{ expense.total|intcomma }}</span>
                            </div>

                            {% if total_expenses > 0 %}
                            <div class="w-full bg-[var(--bg-card)] rounded-full h-2.5 overflow-hidden">
                                <div class="bg-gradient-to-r from-rose-500 to-pink-500 h-full rounded-full transition-all duration-1000 ease-out group-hover:shadow-[0_0_12px_rgba(244,63,94,0.6)]"
                                     style="width: {% widthratio expense.total total_expenses 100 %}%">
                                </div>
                            </div>
                            <div class="flex justify-between mt-2 text-[10px] text-[var(--text-muted)]">
                                <span>{{ expense.count }} {% trans "Transactions" %}</span>
                                <span>{% widthratio expense.total total_expenses 100 %}% {% trans "of total" %}</span>
                            </div>
                            {% endif %}
                        </div>
                    {% empty %}
                        <div class="col-span-full text-center py-10">
                            <div class="w-16 h-16 bg-[var(--bg-body)] rounded-full flex items-center justify-center mx-auto mb-3 text-[var(--text-muted)]">
                                <i data-feather="dollar-sign" class="w-6 h-6 opacity-50"></i>
                            </div>
                            <p class="text-[var(--text-muted)]">{% trans "No significant expenses found for this period." %}</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="lg:col-span-1 space-y-6">
             <div class="bg-gradient-to-br from-indigo-900/40 to-slate-900/40 backdrop-blur-md rounded-3xl p-6 border border-indigo-500/20 shadow-2xl relative overflow-hidden group">
                <div class="absolute -top-10 -right-10 w-32 h-32 bg-indigo-500/20 rounded-full blur-2xl group-hover:bg-indigo-500/30 transition-all"></div>

                <h3 class="text-xl font-black text-white mb-6 flex items-center gap-3">
                    <span class="p-2 bg-indigo-500 rounded-lg text-white shadow-lg shadow-indigo-500/40"><i data-feather="sliders" class="w-5 h-5"></i></span>
                    {% trans "Filter Reports" %}
                </h3>

                <form method="get" id="filter-form" class="space-y-5 relative z-10">

                    <div>
                        <label class="text-[10px] font-bold text-indigo-200 uppercase tracking-widest mb-2 block">{% trans "Select Year" %}</label>
                        <div class="relative">
                            <select name="year" id="year-select" class="w-full bg-slate-900/50 border border-indigo-500/30 text-white rounded-xl px-4 py-3 appearance-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all hover:bg-slate-800/80 cursor-pointer">
                                {% for year in years %}
                                    <option value="{{ year }}" {% if selected_year == year|stringformat:"s" %}selected{% endif %}>{{ year }}</option>
                                {% endfor %}
                            </select>
                            <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-indigo-400">
                                <i data-feather="chevron-down" class="w-4 h-4"></i>
                            </div>
                        </div>
                    </div>

                    <div>
                         <label class="text-[10px] font-bold text-indigo-200 uppercase tracking-widest mb-2 block">{% trans "Select Month" %}</label>
                        <div class="relative">
                            <select name="month" id="month-select" class="w-full bg-slate-900/50 border border-indigo-500/30 text-white rounded-xl px-4 py-3 appearance-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all hover:bg-slate-800/80 cursor-pointer">
                                <option value="">{% trans "All Year" %}</option>
                                {% for month_num, month_name in months.items %}
                                    <option value="{{ month_num }}" {% if selected_month == month_num|stringformat:"s" %}selected{% endif %}>{{ month_name }}</option>
                                {% endfor %}
                            </select>
                            <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-indigo-400">
                                <i data-feather="chevron-down" class="w-4 h-4"></i>
                            </div>
                        </div>
                    </div>

                     <input type="hidden" name="timeframe" value="{{ current_timeframe }}">

                     <button type="submit" class="w-full py-4 rounded-xl bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold shadow-lg shadow-indigo-500/30 hover:shadow-indigo-500/50 hover:-translate-y-0.5 active:scale-95 transition-all duration-200 flex items-center justify-center gap-2 mt-4">
                         {% trans "Apply Filters" %}
                         <i data-feather="arrow-right" class="w-4 h-4"></i>
                     </button>
                </form>
            </div>

            </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('activityChart');
        if (ctx) {
            new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: {{ chart_labels|safe }},
                    datasets: [
                        {
                            label: '{% trans "Income" %}',
                            data: {{ income_data|safe }},
                            borderColor: '#10b981', // Emerald 500
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0,
                            pointHoverRadius: 6
                        },
                        {
                            label: '{% trans "Expenses" %}',
                            data: {{ expense_data|safe }},
                            borderColor: '#f43f5e', // Rose 500
                            backgroundColor: 'rgba(244, 63, 94, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            fill: true,
                            pointRadius: 0,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#94a3b8', font: {family: 'inherit'} },
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            border: { display: false }
                        },
                        x: {
                            ticks: { color: '#94a3b8', font: {family: 'inherit'} },
                            grid: { display: false },
                            border: { display: false }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#cbd5e1', usePointStyle: true, boxWidth: 6 } },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            titleColor: '#fff',
                            bodyColor: '#cbd5e1',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            padding: 10,
                            cornerRadius: 8,
                            displayColors: true
                        }
                    }
                }
            });
        }
    });
</script>
{% endblock %}