{% extends "dashboard/base.html" %}
{% load i18n %}
{% load custom_filters %}

{% block title %}{% trans "Subscriptions Management" %}{% endblock %}
{% block page_title %}{% trans "Monthly Subscriptions" %}{% endblock %}
{% block page_title_desktop %}{% trans "Monthly Subscriptions Dashboard" %}{% endblock %}

{% block content %}
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    <div class="glass-card p-6 flex flex-col justify-center">
        <h3 class="text-lg text-[var(--text-secondary)]">{% trans "Total GB's Sold" %}</h3>
        <p class="text-3xl font-bold mt-2">{{ total_giga_sold }} <span class="text-lg">GB</span></p>
    </div>
    <div class="glass-card p-6 flex items-center justify-between">
        <div>
            <h3 class="text-lg text-[var(--text-secondary)]">{% trans "Total Paid Revenue" %}</h3>
            <p class="text-3xl font-bold text-success mt-2">{{ paid_amount|floatformat:0 }}</p>
        </div>
        <div id="paid-chart"></div>
    </div>
    <div class="glass-card p-6 flex items-center justify-between">
        <div>
            <h3 class="text-lg text-[var(--text-secondary)]">{% trans "Total Unpaid" %}</h3>
            <p class="text-3xl font-bold text-danger mt-2">{{ unpaid_amount|floatformat:0 }}</p>
        </div>
        <div id="unpaid-chart"></div>
    </div>
</div>

<div class="glass-card p-6 mt-6">
    <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
        <h2 class="text-xl font-bold">{% trans "Subscriptions for" %} {{ months|get_item:selected_month }} {{ selected_year }}</h2>

        <form method="get" class="w-full md:w-auto">
            <div class="flex flex-col sm:flex-row flex-wrap items-center gap-2">
                <select name="month" class="form-input w-full sm:w-auto">
                    {% for month_num, month_name in months.items %}
                        <option value="{{ month_num }}" {% if month_num == selected_month %}selected{% endif %}>{{ month_name }}</option>
                    {% endfor %}
                </select>
                <select name="year" class="form-input w-full sm:w-auto">
                    {% for year in years %}
                        <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
                    {% endfor %}
                </select>
                <input type="search" name="q" value="{{ search_query }}" placeholder="{% trans 'Search customer...' %}" class="form-input w-full sm:w-auto">
                <select name="status" class="form-input w-full sm:w-auto">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>{% trans "All" %}</option>
                    <option value="paid" {% if status_filter == 'paid' %}selected{% endif %}>{% trans "Paid" %}</option>
                    <option value="unpaid" {% if status_filter == 'unpaid' %}selected{% endif %}>{% trans "Unpaid" %}</option>
                </select>
                <button type="submit" class="btn btn-primary w-full sm:w-auto">{% trans "Filter" %}</button>
            </div>
        </form>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full text-start">
            <thead>
                <tr class="border-b border-[var(--border-color)]">
                    <th class="p-3 text-start">{% trans "Customer" %}</th>
                    <th class="p-3 text-start">{% trans "Price" %}</th>
                    <th class="p-3 text-start">GB</th>
                    <th class="p-3 text-start">{% trans "Payment Date" %}</th>
                    <th class="p-3 text-start">{% trans "Expiration Date (G)" %}</th>
                    <th class="p-3 text-start">{% trans "Status" %}</th>
                    <th class="p-3 text-center">{% trans "Actions" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for sub in subscriptions %}
                    <tr class="border-b border-[var(--border-color)] transition-colors duration-200 hover:bg-[var(--glass-bg)]">
                        <td class="p-3 font-semibold">{{ sub.customer.name }}</td>
                        <td class="p-3">{{ sub.price|floatformat:0 }}</td>
                        <td class="p-3">{{ sub.giga }}</td>
                        <td class="p-3">{{ sub.jalali_payment_date }}</td>
                        <td class="p-3">{{ sub.expire_date|date:"Y/m/d"|default:"Not Set" }}</td>
                        <td class="p-3">
                            {% if sub.status == 'success' %}
                                <span class="badge badge-success">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                                    {% trans "Paid" %}
                                </span>
                            {% else %}
                                <span class="badge badge-danger">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                                    {% trans "Unpaid" %}
                                </span>
                            {% endif %}
                        </td>
                        <td class="p-3 text-center">
                            <div class="flex items-center justify-center gap-2">
                                <a href="{% url 'dashboard:subscription_edit' sub.id %}" class="font-semibold text-[var(--accent)] hover:underline">{% trans "Edit" %}</a>
                                <span class="text-[var(--text-secondary)]">|</span>
                                <button type="button"
                                        data-url="{% url 'dashboard:subscription_delete' sub.id %}"
                                        data-name="{{ sub.customer.name }}"
                                        onclick="openDeleteModal(this)"
                                        class="font-semibold text-danger hover:underline">
                                    {% trans "Delete" %}
                                </button>
                                </div>
                        </td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="7" class="p-6 text-center text-[var(--text-secondary)]">{% trans "No subscriptions found for this period." %}</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="glass-card p-8 mt-6">
    <h2 class="text-2xl font-bold mb-4">{% trans "Add New Subscription" %}</h2>
    <form method="post" action="{% url 'dashboard:subscription_dashboard' %}?year={{ selected_year }}&month={{ selected_month }}" class="space-y-4 form-container">
    {% csrf_token %}
        {% if form.errors %}
            <div class="alert alert-error">
                <p class="font-bold mb-2">{% trans "Please correct the errors below:" %}</p>
                {{ form.non_field_errors }}
                <ul class="list-disc list-inside">
                {% for field in form %}
                    {% for error in field.errors %}
                        <li>{{ field.label }}: {{ error }}</li>
                    {% endfor %}
                {% endfor %}
                </ul>
            </div>
        {% endif %}
        {{ form.as_p }}
        <button type="submit" name="add_subscription" class="w-full btn btn-gradient mt-4">{% trans "Add Subscription" %}</button>
        </form>
</div>

<div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center p-4">
    <div class="glass-card p-8 rounded-lg shadow-xl w-full max-w-md">
        <h2 class="text-xl font-bold mb-4">{% trans "Confirm Deletion" %}</h2>
        <p class="mb-6">{% blocktrans %}Are you sure you want to delete the subscription for <strong id="customerName"></strong>? This action cannot be undone.{% endblocktrans %}</p>
        <form id="deleteForm" method="post" action=""> {% csrf_token %}
            <div class="flex justify-end gap-4">
                <button type="button" onclick="closeDeleteModal()" class="btn btn-secondary">{% trans "Cancel" %}</button>
                <button type="submit" class="btn btn-danger">{% trans "Yes, Delete" %}</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
$(document).ready(function() {
    $('#id_customer').select2({ theme: "classic", placeholder: "{% trans 'Select a customer...' %}" });
    $('#id_referrer').select2({ theme: "classic", placeholder: "{% trans 'Select a referrer...' %}", allowClear: true });
    $('#id_destination_bank').select2({ theme: "classic", placeholder: "{% trans 'Select a bank account...' %}", allowClear: true });

    const totalAmount = {{ total_amount|default:0 }};
    const paidAmount = {{ paid_amount|default:0 }};
    const theme = document.body.getAttribute('data-theme') || 'dark';
    const paidPercentage = totalAmount > 0 ? Math.round((paidAmount / totalAmount) * 100) : 0;
    const unpaidPercentage = 100 - paidPercentage;

    const chartOptions = {
        chart: { type: 'radialBar', height: 120, sparkline: { enabled: true } },
        plotOptions: { radialBar: { hollow: { size: '60%' }, track: { background: theme === 'dark' ? '#374151' : '#E5E7EB' }, dataLabels: { show: true, name: { show: false }, value: { show: true, fontSize: '20px', fontWeight: 'bold', offsetY: 8, formatter: (val) => val + '%' } } } },
        stroke: { lineCap: 'round' },
        theme: { mode: theme }
    };

    if (document.querySelector("#paid-chart")) {
        const paidChart = new ApexCharts(document.querySelector("#paid-chart"), {...chartOptions, series: [paidPercentage], colors: ['#10B981']});
        paidChart.render();
    }

    if (document.querySelector("#unpaid-chart")) {
        const unpaidChart = new ApexCharts(document.querySelector("#unpaid-chart"), {...chartOptions, series: [unpaidPercentage], colors: ['#EF4444']});
        unpaidChart.render();
    }
});

// START: CHANGE - منطق جاوااسکریپت برای مودال حذف با کد سالم جایگزین شد
const deleteModal = document.getElementById('deleteModal');
const deleteForm = document.getElementById('deleteForm');
const customerNameSpan = document.getElementById('customerName');

function openDeleteModal(button) {
    // گرفتن URL و نام از data attributes دکمه
    const url = button.dataset.url;
    const name = button.dataset.name;

    // تنظیم action فرم و نام مشتری در مودال
    deleteForm.action = url;
    customerNameSpan.textContent = name;

    // نمایش مودال
    deleteModal.classList.remove('hidden');
}

function closeDeleteModal() {
    deleteModal.classList.add('hidden');
}

// بستن مودال با کلیک بیرون از آن
window.onclick = function(event) {
    if (event.target == deleteModal) {
        closeDeleteModal();
    }
}
// END: CHANGE
</script>
{% endblock %}